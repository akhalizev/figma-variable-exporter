<!DOCTYPE html>
<html>
<head>
  <title>Variable Exporter and Counter</title>
  <style>
    body { 
      font-family: Arial, sans-serif; 
      padding: 20px;
      margin: 0;
      color: #333;
    }
    h1 {
      font-size: 18px;
      margin-bottom: 15px;
    }
    h2 {
      font-size: 16px;
      margin-top: 15px;
      margin-bottom: 10px;
      border-bottom: 1px solid #eee;
      padding-bottom: 5px;
    }
    button { 
      padding: 8px 16px; 
      margin-top: 15px;
      background: #18A0FB;
      color: white;
      border: none;
      border-radius: 6px;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.2s ease;
    }
    button:hover {
      background: #0D8CE0;
    }
    .meta {
      font-size: 12px;
      color: #666;
      margin-bottom: 15px;
    }
    #variables-preview {
      margin-top: 15px;
      max-height: 350px;
      overflow-y: auto;
      border: 1px solid #eee;
      border-radius: 4px;
      padding: 10px;
    }
    .variable-group {
      margin-bottom: 15px;
    }
    .variable-item {
      margin-bottom: 8px;
      padding-bottom: 8px;
      border-bottom: 1px solid #f5f5f5;
      font-size: 13px;
    }
    .color-preview {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 1px solid #ddd;
      vertical-align: middle;
      margin-right: 5px;
      border-radius: 3px;
    }
    .format-options {
      margin-top: 15px;
      padding: 10px;
      border: 1px solid #eee;
      border-radius: 4px;
      background: #f9f9f9;
    }
    select {
      padding: 5px;
      border-radius: 4px;
      border: 1px solid #ddd;
    }
    .tab-controls {
      display: flex;
      border-bottom: 1px solid #eee;
      margin-bottom: 10px;
    }
    .tab {
      padding: 8px 12px;
      cursor: pointer;
      border-bottom: 2px solid transparent;
    }
    .tab.active {
      border-bottom: 2px solid #18A0FB;
      font-weight: 500;
    }
    .type-count {
      color: #999;
      font-size: 12px;
      margin-left: 5px;
    }
    
    /* Export section styles */
    .export-section {
        margin-bottom: 20px;
        padding: 15px;
        border: 1px solid #e1e5e9;
        border-radius: 6px;
        background: #f8f9fa;
    }
    
    .export-section h3 {
        margin: 0 0 10px 0;
        font-size: 14px;
        font-weight: 600;
        color: #1e1e1e;
    }
    
    .export-options {
        display: flex;
        flex-direction: column;
        gap: 8px;
        margin-bottom: 10px;
    }
    
    .checkbox-group {
        display: flex;
        align-items: center;
        gap: 6px;
    }
    
    .input-group {
        display: flex;
        align-items: center;
        gap: 6px;
    }
    
    .input-group input[type="text"], .input-group input[type="number"] {
        flex: 1;
        padding: 4px 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 12px;
    }
    
    .export-buttons {
        display: flex;
        gap: 8px;
    }
    
    .export-buttons button {
        flex: 1;
    }
    
    .tabs {
        display: flex;
        border-bottom: 1px solid #eee;
        margin-bottom: 20px;
    }
    
    .tab-button {
        background: none;
        border: none;
        padding: 10px 15px;
        cursor: pointer;
        border-bottom: 2px solid transparent;
        margin: 0;
        margin-top: 0;
    }
    
    .tab-button.active {
        border-bottom-color: #18A0FB;
        color: #18A0FB;
    }
    
    .tab-content {
        display: none;
    }
    
    .tab-content.active {
        display: block;
    }
  </style>
</head>
<body>
  <div class="tabs">
    <button class="tab-button active" onclick="showTab('preview')">Preview</button>
    <button class="tab-button" onclick="showTab('export')">Export</button>
  </div>

  <div id="preview-tab" class="tab-content active">
    <h1>Variable Exporter</h1>
    <div class="meta">
      <div>File: <span id="file-name">Loading...</span></div>
      <div>Total variables: <span id="count">0</span></div>
    </div>
    <div id="variables-preview">Loading variables...</div>
  </div>

  <div id="export-tab" class="tab-content">
    <div class="export-section">
      <h3>JSON Export</h3>
      <div class="export-options">
        <div class="checkbox-group">
          <input type="checkbox" id="organized-format" checked>
          <label for="organized-format">Organized format (group by type)</label>
        </div>
        <div class="input-group">
          <label for="json-indent">Indentation:</label>
          <input type="number" id="json-indent" value="2" min="0" max="8">
        </div>
      </div>
      <button id="export-json">Export JSON</button>
    </div>

    <div class="export-section">
      <h3>CSS Export</h3>
      <div class="export-options">
        <div class="checkbox-group">
          <input type="checkbox" id="css-use-prefix">
          <label for="css-use-prefix">Use variable prefix</label>
        </div>
        <div class="input-group">
          <label for="css-prefix">Prefix:</label>
          <input type="text" id="css-prefix" value="figma-" placeholder="e.g., figma-">
        </div>
        <div class="checkbox-group">
          <input type="checkbox" id="css-group-collections" checked>
          <label for="css-group-collections">Group by type</label>
        </div>
        <div class="checkbox-group">
          <input type="checkbox" id="css-remove-duplicates" checked>
          <label for="css-remove-duplicates">Remove duplicate words (e.g., accordion-accordion â†’ accordion)</label>
        </div>
      </div>
      <button id="export-css">Export CSS</button>
    </div>

    <div class="export-section">
      <h3>Style Guide</h3>
      <p>Create a visual style guide frame in your Figma file.</p>
      <button id="create-style-guide">Create Style Guide</button>
    </div>
  </div>
    <div class="export-options">
      <div class="checkbox-group">
        <input type="checkbox" id="include-comments" checked>
        <label for="include-comments">Include Comments</label>
      </div>
      <div class="input-group">
        <label for="file-name-input">File Name:</label>
        <input type="text" id="file-name-input" placeholder="Enter file name">
      </div>
    </div>
    
    <div class="export-buttons">
      <button id="export">Export Variables</button>
      <button id="create-style-guide" style="background-color: #4CAF50;">Create Style Guide Frame</button>
    </div>
  </div>

  <script>
    // State variables
    let exportData = null;
    
    // Function to show/hide tabs
    function showTab(tabName) {
      // Hide all tab contents
      document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
      });
      
      // Remove active class from all tab buttons
      document.querySelectorAll('.tab-button').forEach(button => {
        button.classList.remove('active');
      });
      
      // Show selected tab content
      document.getElementById(tabName + '-tab').classList.add('active');
      
      // Add active class to clicked button
      event.target.classList.add('active');
    }
    
    // Event listeners for export buttons
    document.getElementById('export-json').addEventListener('click', () => {
      const organized = document.getElementById('organized-format').checked;
      const indent = parseInt(document.getElementById('json-indent').value);
      
      parent.postMessage({
        pluginMessage: {
          type: 'export-json',
          organized: organized,
          indent: indent
        }
      }, '*');
    });

    document.getElementById('export-css').addEventListener('click', () => {
      const usePrefix = document.getElementById('css-use-prefix').checked;
      const prefix = document.getElementById('css-prefix').value;
      const groupByCollection = document.getElementById('css-group-collections').checked;
      const removeDuplicateWords = document.getElementById('css-remove-duplicates').checked;
      
      parent.postMessage({
        pluginMessage: {
          type: 'export-css',
          options: {
            usePrefix: usePrefix,
            prefix: prefix,
            groupByCollection: groupByCollection,
            removeDuplicateWords: removeDuplicateWords
          }
        }
      }, '*');
    });

    document.getElementById('create-style-guide').addEventListener('click', () => {
      parent.postMessage({
        pluginMessage: { 
          type: 'create-style-guide',
          data: exportData
        }
      }, '*');
    });
    
    // Function to render preview
    function renderPreview(data) {
      const previewEl = document.getElementById('variables-preview');
      previewEl.innerHTML = '';
      
      if (!data) {
        previewEl.textContent = 'No variables found';
        return;
      }
      
      const { variablesByType } = data;
      
      if (Object.keys(variablesByType).length === 0) {
        previewEl.textContent = 'No variables found';
        return;
      }
      
      // Create groups for each variable type
      Object.keys(variablesByType).forEach(type => {
        const typeData = variablesByType[type];
        
        const groupEl = document.createElement('div');
        groupEl.className = 'variable-group';
        
        const titleEl = document.createElement('div');
        titleEl.className = 'variable-group-title';
        titleEl.textContent = `${type} (${typeData.count})`;
        groupEl.appendChild(titleEl);
        
        typeData.variables.forEach(variable => {
          const itemEl = document.createElement('div');
          itemEl.className = 'variable-item';
          
          const nameEl = document.createElement('span');
          nameEl.className = 'variable-name';
          nameEl.textContent = variable.name;
          itemEl.appendChild(nameEl);
          
          const valueEl = document.createElement('span');
          valueEl.className = 'variable-value';
          
          if (type === 'COLOR' && variable.value && typeof variable.value === 'object' && variable.value.hex) {
            // Create color swatch for color variables
            const swatchEl = document.createElement('span');
            swatchEl.className = 'color-swatch';
            swatchEl.style.backgroundColor = variable.value.hex;
            swatchEl.title = variable.value.hex;
            valueEl.appendChild(swatchEl);
            
            const hexEl = document.createElement('span');
            hexEl.textContent = variable.value.hex;
            valueEl.appendChild(hexEl);
          } else {
            valueEl.textContent = JSON.stringify(variable.value);
          }
          
          itemEl.appendChild(valueEl);
          groupEl.appendChild(itemEl);
        });
        
        previewEl.appendChild(groupEl);
      });
    }
    
    // Handle messages from plugin
    window.addEventListener('message', (event) => {
      const msg = event.data.pluginMessage;
      
      if (msg.type === 'variables-data') {
        exportData = msg.data;
        renderPreview(exportData);
      } else if (msg.count !== undefined) {
        exportData = msg.exportData;
        document.getElementById('count').textContent = msg.count;
        document.getElementById('file-name').textContent = msg.exportData.metadata.fileName;
        renderPreview(msg.exportData);
      } else if (msg.type === 'download-file') {
        // Handle file downloads
        const blob = new Blob([msg.content], { type: msg.mimeType });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = msg.filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }
    });
    
    // Request initial data
    parent.postMessage({
      pluginMessage: { type: 'get-variables' }
    }, '*');
  </script>
      
      // Render each variable type group
      Object.entries(variablesByType).forEach(([type, typeData]) => {
        const groupEl = document.createElement('div');
        groupEl.className = 'variable-group';
        
        const groupTitle = document.createElement('h2');
        groupTitle.textContent = type;
        groupTitle.innerHTML += ` <span class="type-count">(${typeData.count})</span>`;
        groupEl.appendChild(groupTitle);
        
        // Render variables for this type
        typeData.variables.forEach(variable => {
          const itemEl = document.createElement('div');
          itemEl.className = 'variable-item';
          
          // Create special preview for color variables
          if (type === 'COLOR' && variable.value && variable.value.hex) {
            const colorPreview = document.createElement('span');
            colorPreview.className = 'color-preview';
            colorPreview.style.backgroundColor = variable.value.hex;
            itemEl.appendChild(colorPreview);
          }
          
          // Variable name
          const nameEl = document.createElement('strong');
          nameEl.textContent = variable.name;
          itemEl.appendChild(nameEl);
          
          // Value display
          let valueText = '';
          if (type === 'COLOR' && variable.value && variable.value.hex) {
            valueText = `: ${variable.value.hex}`;
          } else if (typeof variable.value === 'number') {
            valueText = `: ${variable.value}`;
          } else if (typeof variable.value === 'string') {
            valueText = `: "${variable.value}"`;
          }
          
          if (valueText) {
            itemEl.appendChild(document.createTextNode(valueText));
          }
          
          groupEl.appendChild(itemEl);
        });
        
        previewEl.appendChild(groupEl);
      });
    }
    
    // Function to prepare export data based on selected format
    function prepareExportData() {
      if (!exportData) return null;
      
      if (selectedFormat === 'organized') {
        return exportData;
      } else {
        // Create flat list format
        const flatList = [];
        Object.entries(exportData.variablesByType).forEach(([type, typeData]) => {
          typeData.variables.forEach(variable => {
            flatList.push(variable);
          });
        });
        
        return {
          metadata: exportData.metadata,
          variables: flatList
        };
      }
    }
    
    // Listen for messages from code.ts
    window.onmessage = (event) => {
      const { type, count, exportData: data, error } = event.data.pluginMessage;

      if (error) {
        console.error("Figma plugin error:", error);
        // Optionally display the error in the UI
        alert("Error: " + error);
        return;
      }
      
      if (type === 'style-guide-created') {
        alert('Style guide frame created successfully!');
        return;
      }
      
      // Store data for later use
      exportData = data;
      
      // Update UI elements
      document.getElementById('count').textContent = count;
      document.getElementById('file-name').textContent = data.metadata.fileName;
      
      // Render the preview
      renderPreview(data);
      
      // Handle export button click
      document.getElementById('export').onclick = () => {
        const dataToExport = prepareExportData();
        if (!dataToExport) return;
        
        // Determine indentation
        let indent = selectedIndentation;
        if (typeof indent === 'number') {
          indent = ' '.repeat(indent);
        }
        
        const json = JSON.stringify(dataToExport, null, indent);
        const blob = new Blob([json], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${data.metadata.fileName.replace(/\s+/g, '-')}-variables.json`;
        a.click();
        URL.revokeObjectURL(url);
      };

      // Handle create style guide button click
      document.getElementById('create-style-guide').onclick = () => {
        parent.postMessage({ pluginMessage: { type: 'create-style-guide', data: exportData } }, '*');
      };
    };
  </script>
</body>
</html>